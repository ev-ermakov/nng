name: coverage
on: [push]
jobs:

  linux-coverage:
    name: linux
    runs-on: [ ubuntu-20.04 ]
    steps:
    - name: Check out code
      uses: actions/checkout@v1

    - name: Install mbedTLS
      run: sudo apt-get install libmbedtls-dev

    - name: Install meson
      run: sudo apt-get install meson

    - name: Configure
      run: meson build --buildtype debug -Db_coverage=true -Dnng_tls=true

    - name: build
      run: cd build && ninja

    - name: Test
      run: cd build && meson test --print-errorlogs

    - name: Upload report
      uses: codecov/codecov-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        yml: ./.codecov.yml

  darwin-coverage:
    name: darwin
    runs-on: [ macos-latest ]
    steps:
      - name: Check out code
        uses: actions/checkout@v1

      - name: Install mbedTLS
        run: brew install mbedtls

      - name: Install meson
        run: brew install meson

      - name: Install lcov
        run: brew install lcov

      - name: Configure
        run:  meson build --buildtype debug -Db_coverage=true -Dnng_tls=true

      - name: build
        run: meson compile -C build

      - name: Test
        run: meson test -C build --print-errorlogs

      - name: Preprocess
        run: cd build && lcov -c -d . -o lcov.info

      - name: Upload report
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          yml: ./.codecov.yml
